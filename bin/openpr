#!/bin/bash

# Author: William Heryanto

# fuction to show help mesage
usage() {
    cat <<END
Open PR to master branch from other branch.

Usage:
  openpr [option]

Flags:
  -h: show the help message
  -b: specifying branch argument
  -u: open PR to upstream master branch
END
}

# function to handle erros
error() {
    echo "Error: $1"
    exit $2
} >&2

# get the current active branch
current_branch=$(git rev-parse --abbrev-ref HEAD)
target_branch='integration'
remote_repository="origin"
upstream_flag=0

while [[ $# -gt 0 ]]; do
    key="$1"
    case $key in
    -b | --branch)
        target_branch="$2"
        shift
        shift
        ;;
    -u | --upstream)
        upstream_flag=1
        shift
        ;;
    -h | --help)
        usage
        shift
        exit 0
        ;;
    *)
        error "argument not supported" 1
        ;;
    esac
done

echo $target_branch $current_branch

# verify to not in master branch
if [[ $target_branch = $current_branch ]]; then
    error "The target branch is the same as current branch" 1
fi

# retrieve repo url
repository_url=$(git remote get-url $remote_repository | sed -e 's/git@//' -e 's/:/\//' -e 's/.git//')

declare pr_url=""

# handling upstream
if [[ $upstream_flag -eq 1 ]]; then
    origin_user=$(git remote get-url origin | sed -e 's/git@github.com://' -e 's/\/.*//')
    pr_url="https://$repository_url/compare/$target_branch...$origin_user:$current_branch"
else
    pr_url="https://$repository_url/compare/$target_branch...$current_branch"
fi

open $pr_url

exit 0
